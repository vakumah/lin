name: Linux Zero-Lag 8-Bit (Fixed Version)

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Global Clean & Performance Prep
      run: |
        # Menggunakan || true agar mengabaikan error jika servis tidak ditemukan
        sudo systemctl stop unattended-upgrades || true
        sudo apt-get remove -y google-cloud-cli azure-cli dotnet-sdk-* mono-complete || true

    - name: Install TigerVNC & XFCE (Ultra-Light)
      run: |
        sudo apt update
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-terminal tigervnc-standalone-server firefox --no-install-recommends
        
        mkdir -p ~/.vnc
        echo -e "p@ssw0rd!\np@ssw0rd!\nn" | vncpasswd
        chmod 600 ~/.vnc/passwd

        cat > ~/.vnc/xstartup << 'VNCSTART'
        #!/bin/bash
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        startxfce4 &
        VNCSTART
        chmod +x ~/.vnc/xstartup

    - name: Extreme 8-Bit & Network "Doping"
      run: |
        # Mematikan compositor XFCE via command line agar tidak lag
        mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml
        echo '<?xml version="1.0" encoding="UTF-8"?><channel name="xfwm4" version="1.0"><property name="general" type="empty"><property name="use_compositing" type="bool" value="false"/></property></channel>' > ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml

        # Jalankan VNC 8-Bit
        vncserver -kill :1 || true
        vncserver :1 -geometry 1024x768 -depth 8 -localhost no -rfbport 5901

        # Tweak Network Latency
        sudo sysctl -w net.ipv4.tcp_low_latency=1
        sudo sysctl -w net.ipv4.tcp_fastopen=3

    - name: Firefox "Potato Mode"
      run: |
        sudo mkdir -p /etc/firefox/syspref.js
        echo 'pref("gfx.webrender.all", false);' | sudo tee -a /etc/firefox/syspref.js
        echo 'pref("layers.acceleration.disabled", true);' | sudo tee -a /etc/firefox/syspref.js

    - name: Start Playit Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit-linux-amd64
        ./playit-linux-amd64 --secret $PLAYIT_AUTH_KEY &
        sleep 10

    - name: Monitoring & Auto-Clean
      run: |
        echo "VNC 8-Bit Aktif! Silakan hubungkan."
        while true; do
          sync; echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          sleep 120
        done
