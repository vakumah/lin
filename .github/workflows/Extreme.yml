name: Linux Zero-Lag 8-Bit (Ultra-Final-Fix)

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Global Clean & Performance Prep
      run: |
        # Menggunakan || true agar tidak error jika servis tidak ada
        sudo systemctl stop unattended-upgrades || true
        sudo apt-get remove -y google-cloud-cli azure-cli dotnet-sdk-* mono-complete || true

    - name: Install TigerVNC & XFCE (Ultra-Light)
      run: |
        sudo apt update
        # Install paket VNC secara lengkap agar binari tersedia
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-terminal tigervnc-standalone-server tigervnc-common firefox --no-install-recommends
        
        # FIX: Buat folder VNC dan buat file password secara manual menggunakan vncpasswd
        # Jika perintah vncpasswd masih error, kita akan pakai cara manual heksadesimal
        mkdir -p ~/.vnc
        
        # Cara ini lebih aman: Menggunakan input otomatis untuk vncpasswd
        printf "p@ssw0rd!\np@ssw0rd!\nn\n" | vncpasswd
        
        # Konfigurasi xstartup
        cat > ~/.vnc/xstartup << 'VNCSTART'
        #!/bin/bash
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        startxfce4 &
        VNCSTART
        chmod +x ~/.vnc/xstartup

    - name: Extreme 8-Bit & Network "Doping"
      run: |
        # Matikan compositor XFCE via config
        mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml
        echo '<?xml version="1.0" encoding="UTF-8"?><channel name="xfwm4" version="1.0"><property name="general" type="empty"><property name="use_compositing" type="bool" value="false"/></property></channel>' > ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml

        # Jalankan VNC 8-Bit (Menggunakan port 5901)
        # Kami tidak menggunakan full path agar sistem mencari secara otomatis di /usr/bin atau /usr/sbin
        vncserver -kill :1 || true
        vncserver :1 -geometry 1024x768 -depth 8 -localhost no

    - name: Start Playit Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit-linux-amd64
        ./playit-linux-amd64 --secret $PLAYIT_AUTH_KEY &
        sleep 10

    - name: Monitoring & Auto-Clean
      run: |
        echo "VNC 8-Bit Berhasil Dijalankan!"
        echo "Password VNC kamu adalah: p@ssw0rd!"
        while true; do
          sync; echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          sleep 120
        done
