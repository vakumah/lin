name: Linux Zero-Lag 8-Bit (Maximum Performance)

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Global Clean & Performance Prep
      run: |
        # Matikan update background agar tidak mencuri bandwidth saat kamu pakai
        sudo systemctl stop unattended-upgrades
        sudo apt-get remove -y google-cloud-cli azure-cli dotnet-sdk-* mono-complete || true

    - name: Install TigerVNC & XFCE (Ultra-Light)
      run: |
        sudo apt update
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-terminal tigervnc-standalone-server firefox --no-install-recommends
        
        mkdir -p ~/.vnc
        echo -e "p@ssw0rd!\np@ssw0rd!\nn" | vncpasswd
        chmod 600 ~/.vnc/passwd

        cat > ~/.vnc/xstartup << 'VNCSTART'
        #!/bin/bash
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        # Matikan dekorasi jendela yang berat
        xfconf-query -c xfwm4 -p /general/use_compositing -n -t bool -s false
        startxfce4 &
        VNCSTART
        chmod +x ~/.vnc/xstartup

    - name: Extreme 8-Bit & Network "Doping"
      run: |
        # 1. PAKSA 8-BIT & RESOLUSI RENDAH (Kunci Utama Anti-Lag)
        # Kita pakai resolusi 1024x768 tapi dengan kedalaman warna 8-bit (256 warna saja)
        vncserver -kill :1 || true
        vncserver :1 -geometry 1024x768 -depth 8 -localhost no -rfbport 5901

        # 2. TWEAK KERNEL UNTUK INTERNET BUSUK
        # Mempercepat pengiriman paket kecil (mouse/keyboard)
        sudo sysctl -w net.ipv4.tcp_nometrics_save=1
        sudo sysctl -w net.ipv4.tcp_low_latency=1
        sudo sysctl -w net.ipv4.tcp_fastopen=3
        sudo sysctl -w net.ipv4.tcp_fin_timeout=15
        sudo sysctl -w net.ipv4.tcp_keepalive_time=60

    - name: Firefox "Potato Mode"
      run: |
        # Buat Firefox tidak merender animasi/gambar berat
        sudo mkdir -p /etc/firefox/syspref.js
        echo 'pref("gfx.webrender.all", false);' | sudo tee -a /etc/firefox/syspref.js
        echo 'pref("layers.acceleration.disabled", true);' | sudo tee -a /etc/firefox/syspref.js
        echo 'pref("image.animation_mode", "none");' | sudo tee -a /etc/firefox/syspref.js

    - name: Start Playit Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit-linux-amd64
        ./playit-linux-amd64 --secret $PLAYIT_AUTH_KEY &
        sleep 10

    - name: Monitoring & Auto-Clean
      run: |
        echo "VNC 8-Bit is Running!"
        while true; do
          # Paksa Linux membuang sampah RAM setiap 2 menit
          sync; echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          sleep 120
        done
