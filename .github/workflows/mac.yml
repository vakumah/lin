name: macOS Desktop

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: System Info
        run: |
          sw_vers
          uname -m
          
      - name: Install VNC Server
        run: |
          brew install tiger-vnc
          
          # Find where binaries are installed
          echo "=== Checking installed binaries ==="
          ls -la $(brew --prefix tiger-vnc)/bin/ || true
          ls -la /opt/homebrew/bin/vnc* || true
          which vncserver || true
          
      - name: Setup and Start VNC
        run: |
          # Add homebrew to path
          export PATH="$(brew --prefix)/bin:$(brew --prefix tiger-vnc)/bin:$PATH"
          
          mkdir -p ~/.vnc
          
          # Try to find and run vncserver
          VNCSERVER=$(find /opt/homebrew -name "vncserver" 2>/dev/null | head -1)
          
          if [ -z "$VNCSERVER" ]; then
            VNCSERVER=$(brew --prefix tiger-vnc)/bin/vncserver
          fi
          
          echo "Using vncserver: $VNCSERVER"
          
          # Start VNC without password (SecurityTypes None)
          $VNCSERVER :1 -geometry 1920x1080 -depth 24 -SecurityTypes None &
          sleep 3
          
          echo "VNC Server started on :1 (port 5901)"
          
      - name: Download Bore
        run: |
          # ARM64 macOS
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          
      - name: Start Tunnel
        run: |
          echo "========================================"
          echo "üçé macOS VNC Ready!"
          echo "üìê Resolution: 1920x1080"
          echo "üîì No password required"
          echo "========================================"
          
          ./bore local 5901 --to bore.pub
