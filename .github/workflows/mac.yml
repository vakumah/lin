name: macOS Desktop

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: System Info
        run: |
          echo "=== macOS Info ==="
          sw_vers
          echo ""
          echo "=== CPU ==="
          sysctl -n machdep.cpu.brand_string || echo "Apple Silicon"
          
      - name: Install VNC Server
        run: |
          brew install tiger-vnc
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          
      - name: Setup VNC
        run: |
          mkdir -p ~/.vnc
          
          # Use full path for vncpasswd
          /opt/homebrew/bin/vncpasswd -f <<< "github123" > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Create simple xstartup
          echo '#!/bin/bash' > ~/.vnc/xstartup
          echo 'open -a Finder' >> ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup
          
      - name: Start VNC Server
        run: |
          /opt/homebrew/bin/vncserver :1 -geometry 1920x1080 -depth 24 -SecurityTypes None &
          sleep 3
          echo "VNC Server started!"
          
      - name: Download Bore
        run: |
          # Download bore for ARM macOS
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          
      - name: Start Tunnel
        run: |
          echo "========================================"
          echo "üçé macOS VNC Ready!"
          echo "========================================"
          echo ""
          echo "üîë No password (SecurityTypes None)"
          echo "üìê Resolution: 1920x1080"
          echo ""
          echo "‚è≥ Starting tunnel..."
          echo ""
          echo "========================================"
          
          ./bore local 5901 --to bore.pub
