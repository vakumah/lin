name: MacOS VNC Fix (Black Screen)

on:
  workflow_dispatch:

jobs:
  macos-setup:
    runs-on: macos-15

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4

    - name: System & GUI Optimization
      run: |
        # 1. Login Otomatis & Disable Screen Lock
        sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser -string "runner"
        sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime -int 0
        
        # 2. Disable Animations
        defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
        defaults write com.apple.finder DisableAllAnimations -bool true
        
        # 3. Mencegah Sleep (Penting!)
        sudo systemsetup -setcomputersleep Never
        sudo systemsetup -setdisplaysleep Never

    - name: Enable VNC (Aggressive Mode)
      run: |
        # Reset Remote Management
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -configure -access -off
        
        # Aktifkan ulang dengan izin penuh
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "Mypassword!" \
          -restart -agent -privs -all
        
        echo "VNC Restarted"

    - name: Force GUI Refresh (The Fix)
      run: |
        # Ini triknya: Kill WindowServer untuk memaksa refresh tampilan
        # Layar mungkin akan disconnect sebentar lalu connect lagi saat masuk VNC
        echo "Restarting WindowServer..."
        sudo killall -HUP WindowServer || true
        sleep 5

    - name: Start Bore Tunnel
      run: |
        curl -L "https://github.com/ekzhang/bore/releases/download/v0.5.2/bore-v0.5.2-x86_64-apple-darwin.tar.gz" -o bore.tar.gz
        tar -xzf bore.tar.gz
        chmod +x bore
        
        echo "Starting Bore..."
        ./bore local 5900 --to bore.pub

    - name: Keep Alive
      if: always()
      run: |
        # Menjalankan caffeinate agar sistem 'melek' terus
        caffeinate -u -i -s
