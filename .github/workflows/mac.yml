name: MacOS 15 VNC (Safe Mode)

on:
  workflow_dispatch:

jobs:
  macos-setup:
    runs-on: macos-15

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4

    - name: System Optimization (VM Friendly)
      run: |
        # Matikan animasi tanpa menyentuh hardware sleep (mencegah error systemsetup)
        defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
        defaults write com.apple.finder DisableAllAnimations -bool true
        
        # Set auto-login untuk memastikan user aktif
        sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser -string "runner"

    - name: Enable VNC (Standard)
      run: |
        # Restart VNC Agent dengan bersih
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "Mypassword!" \
          -restart -agent -privs -all
        
        echo "VNC Ready on Port 5900"

    - name: Start Bore Tunnel
      run: |
        curl -L "https://github.com/ekzhang/bore/releases/download/v0.5.2/bore-v0.5.2-x86_64-apple-darwin.tar.gz" -o bore.tar.gz
        tar -xzf bore.tar.gz
        chmod +x bore
        
        echo "Starting Bore..."
        # Jalan di background agar bisa lanjut ke step Keep Alive
        ./bore local 5900 --to bore.pub &
        
        # Beri waktu bore untuk connect dan print URL
        sleep 5

    - name: Keep Alive & Log URL
      run: |
        echo "Tunnel is running in background. Check previous step logs for URL."
        # Caffeinate mencegah sleep dari sisi software
        caffeinate -u -i -s
