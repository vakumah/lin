name: macOS Desktop

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: System Info
        run: |
          sw_vers
          uname -m
          
      - name: Install XQuartz and VNC
        run: |
          # Install XQuartz (X11 for macOS)
          brew install --cask xquartz
          
          # Install VNC server
          brew install x11vnc tiger-vnc
          
          # Install window manager
          brew install openbox
          
          echo "Installation complete!"
          
      - name: Start Virtual Display
        run: |
          # Source XQuartz
          export PATH="/opt/X11/bin:$PATH"
          export DISPLAY=:1
          
          # Create virtual X display using Xvfb from XQuartz
          /opt/X11/bin/Xvfb :1 -screen 0 1920x1080x24 &
          sleep 3
          
          echo "Virtual display started!"
          
      - name: Start Window Manager
        run: |
          export PATH="/opt/X11/bin:/opt/homebrew/bin:$PATH"
          export DISPLAY=:1
          
          # Start openbox
          openbox &
          sleep 2
          
          # Open some apps
          /opt/X11/bin/xterm &
          
          echo "Window manager started!"
          
      - name: Start VNC Server
        run: |
          export PATH="/opt/X11/bin:/opt/homebrew/bin:$PATH"
          export DISPLAY=:1
          
          # Start x11vnc to share the virtual display
          x11vnc -display :1 -forever -shared -nopw -rfbport 5900 &
          sleep 3
          
          echo "VNC Server started on port 5900!"
          
      - name: Download Bore
        run: |
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          
      - name: Start Tunnel
        run: |
          echo "========================================"
          echo "üçé macOS X11 Desktop Ready!"
          echo "üìê Resolution: 1920x1080"
          echo "üîì No password"
          echo "========================================"
          
          ./bore local 5900 --to bore.pub
