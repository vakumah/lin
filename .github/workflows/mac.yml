name: macOS Desktop

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: Enable VNC without user auth
        run: |
          echo "Current user: $(whoami)"
          
          # Method 1: Try kickstart with VNC-only mode
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -allUsers \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw vnc123 \
            -restart -agent || echo "kickstart failed, trying alternatives..."
          
          # Method 2: Write VNC password directly
          echo "vnc123" | sudo perl -e 'print pack("H*", unpack("H*", <>))' > /tmp/vncpw
          sudo cp /tmp/vncpw /Library/Preferences/com.apple.VNCSettings.txt 2>/dev/null || true
          
          # Method 3: Try enabling via defaults
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true 2>/dev/null || true
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCPassword -string "vnc123" 2>/dev/null || true
          
          sleep 3
          
          echo "=== Port Check ==="
          lsof -i :5900 || echo "Nothing on 5900"
          
      - name: Alternative - Use Xvfb + x11vnc NO AUTH
        run: |
          # Install x11vnc
          brew install x11vnc 2>/dev/null || true
          
          # Try x11vnc with no password in rawfb mode pointing to dummy
          # Create a simple framebuffer
          x11vnc -create -forever -shared -nopw -rfbport 5900 2>/dev/null &
          sleep 2
          
          lsof -i :5900 || echo "Still nothing"
          
      - name: Start Bore
        run: |
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          
          echo "========================================"
          echo "üçé macOS VNC"
          echo "ÔøΩ Try: vnc123 (or no password)"
          echo "========================================"
          
          ./bore local 5900 --to bore.pub
