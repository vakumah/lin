name: macOS Desktop

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: Setup User Password and VNC
        run: |
          # Get current username
          echo "Current user: $(whoami)"
          
          # Set password for current user
          sudo dscl . -passwd /Users/$(whoami) "" "mac123"
          
          # Enable Remote Management with VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -allUsers \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw mac123 \
            -restart -agent
          
          echo ""
          echo "========================================"
          echo "üçé macOS VNC Credentials"
          echo "========================================"
          echo "üë§ Username: $(whoami)"
          echo "üîë Password: mac123"
          echo "üîë VNC Password: mac123"
          echo "========================================"
          
      - name: Check VNC Port
        run: |
          sleep 3
          echo "Checking port 5900..."
          lsof -i :5900 || echo "Nothing on 5900"
          netstat -an | grep 5900 || true
          
      - name: Start Bore Tunnel
        run: |
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          
          echo "========================================"
          echo "üçé macOS VNC Ready!"
          echo "üë§ Username: $(whoami)"
          echo "üîë Password: mac123"
          echo "========================================"
          
          ./bore local 5900 --to bore.pub
