name: macOS Desktop VNC

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: Create VNC User and Enable VNC
        run: |
          # Create new admin user for VNC
          sudo dscl . -create /Users/vncuser
          sudo dscl . -create /Users/vncuser UserShell /bin/bash
          sudo dscl . -create /Users/vncuser RealName "VNC User"
          sudo dscl . -create /Users/vncuser UniqueID 550
          sudo dscl . -create /Users/vncuser PrimaryGroupID 20
          sudo dscl . -create /Users/vncuser NFSHomeDirectory /Users/vncuser
          sudo dscl . -passwd /Users/vncuser "vnc123"
          sudo dscl . -append /Groups/admin GroupMembership vncuser
          
          # Create home directory
          sudo mkdir -p /Users/vncuser
          sudo chown -R vncuser:staff /Users/vncuser
          
          echo "VNC User created!"
          
      - name: Enable Screen Sharing
        run: |
          # Enable VNC/Screen Sharing with kickstart
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -allowAccessFor -specifiedUsers \
            -configure -users vncuser -access -on -privs -all \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw vnc123 \
            -restart -agent
          
          sleep 3
          
          # Check port
          lsof -i :5900 || echo "Checking netstat..."
          netstat -an | grep -E "5900|3283" || true
          
          echo "Screen Sharing enabled!"
          
      - name: Start Tunnel
        run: |
          # Download bore
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          
          echo ""
          echo "========================================"
          echo "üçé macOS VNC Ready!"
          echo "========================================"
          echo "üë§ Username: vncuser"
          echo "üîë Password: vnc123"
          echo "üîë VNC Password: vnc123"
          echo "========================================"
          echo ""
          
          ./bore local 5900 --to bore.pub
