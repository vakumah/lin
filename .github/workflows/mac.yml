name: MacOS 15 VNC (Fixed)

on:
  workflow_dispatch:

jobs:
  macos-setup:
    runs-on: macos-15

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4

    - name: System Optimization
      run: |
        # Matikan Screensaver via User Preferences (bukan pmset)
        defaults -currentHost write com.apple.screensaver idleTime 0
        
        # Disable UI Animations (Performance)
        defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
        defaults write NSGlobalDomain NSWindowResizeTime -float 0.001
        defaults write com.apple.finder DisableAllAnimations -bool true
        
        # Mencegah display sleep dengan caffeinate (background process)
        caffeinate -u -t 20000 &

    - name: Enable VNC (Kickstart)
      run: |
        # Mengaktifkan VNC dengan password "Mypassword!"
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "Mypassword!" \
          -restart -agent -privs -all
        
        echo "VNC Service Started on Port 5900"

    - name: Start Bore Tunnel
      run: |
        curl -L "https://github.com/ekzhang/bore/releases/download/v0.5.2/bore-v0.5.2-x86_64-apple-darwin.tar.gz" -o bore.tar.gz
        tar -xzf bore.tar.gz
        chmod +x bore
        
        echo "Starting Bore..."
        # Cek Log step ini untuk URL. Contoh output: bore.pub:xxxxx
        ./bore local 5900 --to bore.pub

    - name: Keep Alive
      if: always()
      run: |
        while true; do sleep 300; done
