name: macOS VNC Optimization with Bore

on:
  workflow_dispatch:

jobs:
  macos-vnc-setup:
    runs-on: macos-latest

    steps:
    - name: System Tuning & Visual Optimization
      run: |
        # Mematikan animasi sistem agar lebih responsif di koneksi lambat
        defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
        defaults write com.apple.dock expose-animation-duration -float 0.1
        defaults write com.apple.dock "show-process-indicators" -bool false
        killall Dock

    - name: Disable Screen Saver & Sleep (Fix Black Screen)
      run: |
        # Disable screen saver
        defaults -currentHost write com.apple.screensaver idleTime 0
        
        # Disable sleep mode
        sudo pmset -a sleep 0
        sudo pmset -a hibernatemode 0
        sudo pmset -a disablesleep 1
        sudo pmset -a displaysleep 0
        
        # Disable screen lock
        defaults write com.apple.screensaver askForPassword -int 0
        
        # Start caffeinate untuk keep display awake
        caffeinate -d -i -s &
        
        echo "Screen saver dan sleep mode dinonaktifkan"

    - name: Force GUI Login Session
      run: |
        # Dapatkan current user
        CURRENT_USER=$(whoami)
        echo "Current user: $CURRENT_USER"
        
        # Force unlock login window
        sudo security authorizationdb write system.login.console allow
        
        # Enable GUI session for current user
        sudo launchctl asuser $(id -u $CURRENT_USER) launchctl load -S Aqua /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
        
        # Force create a GUI session
        /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -switchToUserID $(id -u $CURRENT_USER) 2>/dev/null || true
        
        echo "GUI session created for $CURRENT_USER"

    - name: Setup Virtual Display & Wake Screen
      run: |
        # Caffeinate harus jalan terus
        caffeinate -d -i -s -u &
        
        # Wake display dengan pmset
        sudo pmset -a womp 1
        sudo pmset wake 1
        
        # Unlock screen
        osascript -e 'tell application "System Events" to keystroke return'
        sleep 1
        
        # Force Desktop to load
        open -a Finder
        open -a "System Preferences"
        sleep 2
        
        # Create window so there's something to see
        osascript <<'EOF'
        tell application "Finder"
            activate
            make new Finder window
            set bounds of front window to {0, 0, 800, 600}
        end tell
        
        tell application "TextEdit"
            activate
            make new document
            set text of front document to "VNC Connected Successfully! ðŸŽ‰"
        end tell
EOF
        
        # Set wallpaper
        osascript -e 'tell application "Finder" to set desktop picture to POSIX file "/System/Library/Desktop Pictures/Solid Colors/Teal.png"' || true
        
        # Screenshot untuk force render (penting!)
        screencapture -x /tmp/screen.png
        
        echo "Display setup complete"

    - name: Enable macOS Screen Sharing (VNC)
      run: |
        # Mengaktifkan Remote Management dan menetapkan password VNC
        # Ganti "p@ssw0rd!" jika diperlukan
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
        -activate -configure -access -on \
        -clientopts -setvnclegacy -vnclegacy yes \
        -clientopts -setvncpw -vncpw "p@ssw0rd!" \
        -restart -agent -privs -all
        
        # Restart VNC service untuk apply semua perubahan
        sudo launchctl unload /System/Library/LaunchDaemons/com.apple.RemoteDesktop.plist 2>/dev/null || true
        sudo launchctl load /System/Library/LaunchDaemons/com.apple.RemoteDesktop.plist 2>/dev/null || true
        
        echo "VNC service started!"

    - name: Install & Launch Bore Tunnel
      run: |
        # Mengunduh Bore versi macOS (coba arm64 dulu untuk Apple Silicon runner)
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-aarch64-apple-darwin.tar.gz -o bore.tar.gz || \
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz -o bore.tar.gz
        tar -xzf bore.tar.gz
        chmod +x bore
        
        # Menjalankan bore di background
        # Menghubungkan port 5900 (VNC) ke bore.pub
        ./bore local 5900 --to bore.pub 2>&1 &
        
        echo "Menunggu koneksi tunnel..."
        sleep 8
        
        echo ""
        echo "=============================================="
        echo "ðŸ–¥ï¸  VNC CONNECTION INFO"
        echo "=============================================="
        echo "Password: p@ssw0rd!"
        echo "Cek log di atas untuk alamat bore.pub:PORT"
        echo "=============================================="

    - name: Keep Alive & Monitoring
      run: |
        echo "macOS VNC sedang berjalan!"
        echo "Gunakan aplikasi VNC Viewer (seperti RealVNC atau Screen Sharing)"
        echo "Alamat IP/Host akan muncul di log di atas pada bagian Bore."
        
        # Loop untuk menjaga workflow tetap hidup
        while true; do
          ps aux | grep bore | grep -v grep > /dev/null
          if [ $? -ne 0 ]; then
            echo "Bore terputus, mencoba menghubungkan kembali..."
            ./bore local 5900 --to bore.pub &
          fi
          sleep 300
        done
