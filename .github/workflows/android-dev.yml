name: macOS VNC Optimization with Bore

on:
  workflow_dispatch:

jobs:
  macos-vnc-setup:
    runs-on: macos-latest

    steps:
    - name: System Tuning & Visual Optimization
      run: |
        # Mematikan animasi sistem agar lebih responsif di koneksi lambat
        defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
        defaults write com.apple.dock expose-animation-duration -float 0.1
        defaults write com.apple.dock "show-process-indicators" -bool false
        killall Dock

    - name: Disable Screen Saver & Sleep (Fix Black Screen)
      run: |
        # Disable screen saver
        defaults -currentHost write com.apple.screensaver idleTime 0
        
        # Disable sleep mode
        sudo pmset -a sleep 0
        sudo pmset -a hibernatemode 0
        sudo pmset -a disablesleep 1
        sudo pmset -a displaysleep 0
        
        # Disable screen lock
        defaults write com.apple.screensaver askForPassword -int 0
        
        # Start caffeinate untuk keep display awake
        caffeinate -d -i -s &
        
        echo "Screen saver dan sleep mode dinonaktifkan"

    - name: Setup Virtual Display
      run: |
        # Simulasi display untuk headless environment
        # Ini penting agar VNC tidak menampilkan layar hitam
        
        # Wake up display
        sudo pmset displaysleepnow || true
        sleep 2
        
        # Kirim keyboard event untuk membangunkan screen
        osascript -e 'tell application "System Events" to keystroke " "'
        
        # Open Finder untuk memastikan GUI aktif
        osascript -e 'tell application "Finder" to activate'
        
        # Set wallpaper agar tidak hitam (opsional)
        osascript -e 'tell application "Finder" to set desktop picture to POSIX file "/System/Library/Desktop Pictures/Solid Colors/Teal.png"'
        
        echo "Virtual display disetup"

    - name: Enable macOS Screen Sharing (VNC)
      run: |
        # Mengaktifkan Remote Management dan menetapkan password VNC
        # Ganti "p@ssw0rd!" jika diperlukan
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
        -activate -configure -access -on \
        -clientopts -setvnclegacy -vnclegacy yes \
        -clientopts -setvncpw -vncpw "p@ssw0rd!" \
        -restart -agent -privs -all

    - name: Install & Launch Bore Tunnel
      run: |
        # Mengunduh Bore versi macOS
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz | tar -xz
        chmod +x bore
        
        # Menjalankan bore di background
        # Menghubungkan port 5900 (VNC) ke bore.pub
        ./bore local 5900 --to bore.pub &
        
        echo "Menunggu koneksi tunnel..."
        sleep 5

    - name: Keep Alive & Monitoring
      run: |
        echo "macOS VNC sedang berjalan!"
        echo "Gunakan aplikasi VNC Viewer (seperti RealVNC atau Screen Sharing)"
        echo "Alamat IP/Host akan muncul di log di atas pada bagian Bore."
        
        # Loop untuk menjaga workflow tetap hidup
        while true; do
          ps aux | grep bore | grep -v grep > /dev/null
          if [ $? -ne 0 ]; then
            echo "Bore terputus, mencoba menghubungkan kembali..."
            ./bore local 5900 --to bore.pub &
          fi
          sleep 300
        done
