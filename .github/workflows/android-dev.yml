name: macOS noVNC with Bore

on:
  workflow_dispatch:

jobs:
  macos-novnc-setup:
    runs-on: macos-latest

    steps:
    - name: System Info
      run: |
        echo "=== System Info ==="
        sw_vers
        echo "User: $(whoami)"
        echo "==================="

    - name: Disable Screen Saver & Sleep
      run: |
        # Disable screen saver
        defaults -currentHost write com.apple.screensaver idleTime 0
        
        # Disable sleep mode
        sudo pmset -a sleep 0
        sudo pmset -a hibernatemode 0
        sudo pmset -a disablesleep 1
        sudo pmset -a displaysleep 0
        
        # Keep system awake
        caffeinate -d -i -s &
        
        echo "Sleep mode disabled"

    - name: Enable macOS Screen Sharing (VNC)
      run: |
        # Set VNC password
        VNC_PASSWORD="p@ssw0rd!"
        
        # Enable Remote Management with VNC
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
        
        echo "VNC Server enabled with password: $VNC_PASSWORD"

    - name: Install noVNC & websockify
      run: |
        # Install pipx untuk manage Python packages
        brew install pipx
        pipx ensurepath
        
        # Install websockify via pipx
        pipx install websockify
        
        # Add pipx bin to PATH
        export PATH="$HOME/.local/bin:$PATH"
        
        # Clone noVNC
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        
        echo "noVNC installed"

    - name: Start noVNC Server
      run: |
        # Add pipx bin to PATH
        export PATH="$HOME/.local/bin:$PATH"
        
        # Start websockify to bridge WebSocket (6080) to VNC (5900)
        cd ~/noVNC
        
        # Try novnc_proxy first (it bundles websockify)
        if [ -f "./utils/novnc_proxy" ]; then
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
        else
          # Fallback to websockify directly
          ~/.local/bin/websockify --web ~/noVNC 6080 localhost:5900 &
        fi
        
        # Wait for server to start
        sleep 5
        
        # Verify it's running
        if lsof -i :6080 > /dev/null 2>&1; then
          echo "‚úÖ noVNC server running on port 6080"
        else
          echo "Trying alternative start method..."
          python3 -m websockify --web ~/noVNC 6080 localhost:5900 &
          sleep 3
        fi

    - name: Install & Launch Bore Tunnel
      run: |
        # Download Bore for macOS
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-aarch64-apple-darwin.tar.gz -o bore.tar.gz 2>/dev/null || \
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz -o bore.tar.gz
        tar -xzf bore.tar.gz
        chmod +x bore
        
        # Start bore tunnel for noVNC (port 6080)
        ./bore local 6080 --to bore.pub &
        BORE_PID=$!
        
        # Wait for bore to connect and show the URL
        sleep 10
        
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë                   üñ•Ô∏è  noVNC ACCESS INFO                      ‚ïë"
        echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        echo "‚ïë  Lihat log di atas untuk URL bore.pub:PORT                   ‚ïë"
        echo "‚ïë  Buka URL tersebut di browser!                               ‚ïë"
        echo "‚ïë                                                              ‚ïë"
        echo "‚ïë  VNC Password: p@ssw0rd!                                     ‚ïë"
        echo "‚ïë                                                              ‚ïë"
        echo "‚ïë  Contoh: http://bore.pub:12345/vnc.html                      ‚ïë"
        echo "‚ïë  (ganti 12345 dengan port dari log bore)                     ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""

    - name: Open Desktop Apps (for visibility)
      run: |
        # Open some apps so there's something to see
        open -a Finder &
        open -a Safari &
        sleep 2
        echo "Desktop apps opened"

    - name: Keep Alive & Monitoring
      run: |
        echo "üñ•Ô∏è noVNC server is running!"
        echo "Access via browser using the bore.pub URL above"
        echo ""
        
        # Keep workflow alive
        COUNTER=0
        while true; do
          COUNTER=$((COUNTER + 1))
          echo "[$COUNTER] Session active... ($(date))"
          
          # Check if noVNC is still running
          if ! lsof -i :6080 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è noVNC stopped, restarting..."
            cd ~/noVNC
            ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
            sleep 3
          fi
          
          # Check if bore is still running
          if ! pgrep -x bore > /dev/null; then
            echo "‚ö†Ô∏è Bore stopped, restarting..."
            ./bore local 6080 --to bore.pub &
            sleep 5
          fi
          
          sleep 300
        done
