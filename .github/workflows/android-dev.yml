name: macOS noVNC with Bore (No Auth)

on:
  workflow_dispatch:

jobs:
  macos-novnc-setup:
    runs-on: macos-latest

    steps:
    - name: System Info
      run: |
        echo "=== System Info ==="
        sw_vers
        echo "User: $(whoami)"
        echo "==================="

    - name: Disable Screen Saver & Sleep
      run: |
        # Disable screen saver
        defaults -currentHost write com.apple.screensaver idleTime 0
        
        # Disable sleep mode
        sudo pmset -a sleep 0
        sudo pmset -a hibernatemode 0
        sudo pmset -a disablesleep 1
        sudo pmset -a displaysleep 0
        
        # Keep system awake
        caffeinate -d -i -s &
        
        echo "Sleep mode disabled"

    - name: Setup VNC Server (No Authentication)
      run: |
        # Install x11vnc via Homebrew (supports no-auth)
        brew install x11vnc
        
        # Start x11vnc without password on port 5900
        # -nopw = no password
        # -forever = don't exit after first client disconnects
        # -shared = allow multiple connections
        # -rfbport = VNC port
        # -bg = run in background
        x11vnc -nopw -forever -shared -rfbport 5900 -bg -o /tmp/x11vnc.log 2>&1 || {
          echo "x11vnc failed, trying built-in VNC..."
          
          # Fallback: Enable built-in Screen Sharing
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -restart -agent -privs -all
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers
        }
        
        sleep 2
        echo "VNC Server started - NO PASSWORD"

    - name: Install noVNC & websockify
      run: |
        # Install pipx untuk manage Python packages
        brew install pipx
        pipx ensurepath
        
        # Install websockify via pipx
        pipx install websockify
        
        # Add pipx bin to PATH
        export PATH="$HOME/.local/bin:$PATH"
        
        # Clone noVNC
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        
        echo "noVNC installed"

    - name: Start noVNC Server
      run: |
        # Add pipx bin to PATH
        export PATH="$HOME/.local/bin:$PATH"
        
        # Start websockify to bridge WebSocket (6080) to VNC (5900)
        cd ~/noVNC
        
        # Start noVNC proxy
        ~/.local/bin/websockify --web ~/noVNC 6080 localhost:5900 &
        
        # Wait for server to start
        sleep 5
        
        # Verify it's running
        if lsof -i :6080 > /dev/null 2>&1; then
          echo "‚úÖ noVNC server running on port 6080"
        else
          echo "Trying alternative..."
          python3 -m websockify --web ~/noVNC 6080 localhost:5900 &
          sleep 3
        fi

    - name: Install & Launch Bore Tunnel
      run: |
        # Download Bore for macOS
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-aarch64-apple-darwin.tar.gz -o bore.tar.gz 2>/dev/null || \
        curl -L https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-apple-darwin.tar.gz -o bore.tar.gz
        tar -xzf bore.tar.gz
        chmod +x bore
        
        # Start bore tunnel for noVNC (port 6080)
        ./bore local 6080 --to bore.pub 2>&1 | tee bore.log &
        BORE_PID=$!
        
        # Wait for bore to connect and get the port
        sleep 10
        
        # Extract port from bore output
        BORE_PORT=$(grep -oE 'bore\.pub:[0-9]+' bore.log | head -1 | cut -d: -f2)
        
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë                        üñ•Ô∏è  noVNC ACCESS INFO                              ‚ïë"
        echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        echo "‚ïë                                                                           ‚ïë"
        echo "‚ïë  üìå URL (copy ke browser):                                                ‚ïë"
        echo "‚ïë                                                                           ‚ïë"
        if [ -n "$BORE_PORT" ]; then
        echo "‚ïë  http://bore.pub:$BORE_PORT/vnc.html?autoconnect=true&encrypt=false        ‚ïë"
        else
        echo "‚ïë  Cek log di atas untuk port, lalu buka:                                   ‚ïë"
        echo "‚ïë  http://bore.pub:PORT/vnc.html?autoconnect=true&encrypt=false             ‚ïë"
        fi
        echo "‚ïë                                                                           ‚ïë"
        echo "‚ïë  ‚úÖ NO PASSWORD - langsung connect!                                       ‚ïë"
        echo "‚ïë                                                                           ‚ïë"
        echo "‚ïë  ‚ö†Ô∏è  Kalau error, coba: http://bore.pub:PORT/vnc_lite.html                ‚ïë"
        echo "‚ïë                                                                           ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        
        # Show bore log for reference
        echo "=== Bore Log ==="
        cat bore.log
        echo "================"

    - name: Open Desktop Apps (for visibility)
      run: |
        # Open some apps so there's something to see
        open -a Finder &
        open -a Safari &
        sleep 2
        echo "Desktop apps opened"

    - name: Keep Alive & Monitoring
      run: |
        echo "üñ•Ô∏è noVNC server is running!"
        echo "Access via browser using the bore.pub URL above"
        echo ""
        
        # Show x11vnc log if exists
        if [ -f /tmp/x11vnc.log ]; then
          echo "=== x11vnc Log ==="
          cat /tmp/x11vnc.log
          echo "=================="
        fi
        
        # Keep workflow alive
        COUNTER=0
        while true; do
          COUNTER=$((COUNTER + 1))
          echo "[$COUNTER] Session active... ($(date))"
          
          # Check if noVNC is still running
          if ! lsof -i :6080 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è noVNC stopped, restarting..."
            export PATH="$HOME/.local/bin:$PATH"
            ~/.local/bin/websockify --web ~/noVNC 6080 localhost:5900 &
            sleep 3
          fi
          
          # Check if bore is still running
          if ! pgrep -x bore > /dev/null; then
            echo "‚ö†Ô∏è Bore stopped, restarting..."
            ./bore local 6080 --to bore.pub &
            sleep 5
          fi
          
          sleep 300
        done
