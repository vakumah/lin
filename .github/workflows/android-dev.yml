name: linux-vnc-pro

on: workflow_dispatch

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: optimize system
        run: |
          # 1. Network Tuning & KVM Barbaric Permission
          sudo sysctl -w net.core.default_qdisc=fq net.ipv4.tcp_congestion_control=bbr net.ipv4.tcp_window_scaling=1
          sudo chown $USER:$USER /dev/kvm 2>/dev/null || true
          sudo chmod 777 /dev/kvm 2>/dev/null || true

      - name: install packages
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq lxqt openbox tigervnc-standalone-server tigervnc-common firefox htop terminal.app xauth curl

      - name: setup vnc
        run: |
          mkdir -p ~/.vnc
          echo "password123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          echo -e "#!/bin/sh\nunset SESSION_MANAGER\nunset DBUS_SESSION_BUS_ADDRESS\nexec startlxqt" > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup
          touch ~/.Xauthority

      - name: start session
        run: |
          vncserver :1 -geometry 1280x720 -depth 24 -localhost no
          
          # Download bore & run directly
          curl -sL https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-unknown-linux-musl.tar.gz | tar -xz
          sudo mv bore /usr/local/bin/
          
          echo "Connect VNC with password: password123"
          # Perintah ini menahan runner tetap hidup (Keep Alive)
          bore local 5901 --to bore.pub
          
