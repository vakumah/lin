name: Playit RDP Tunnel Linux Optimized

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Download and Install Playit
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit-linux-amd64
        sudo mv playit-linux-amd64 /usr/local/bin/playit
        sleep 5

    - name: Install and Configure xRDP + LXQt (Lightweight DE)
      run: |
        sudo apt update
        # Install xRDP, LXQt, Openbox, and dbus-x11
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xrdp lxqt-core lxqt-session openbox lxterminal dbus-x11
        
        # Enable xRDP service
        sudo systemctl enable xrdp
        
        # Force LXQt + Openbox startup
        cat > ~/.xsession << 'EOF'
        export DESKTOP_SESSION=lxqt
        export XDG_CURRENT_DESKTOP=lxqt
        export XDG_SESSION_TYPE=x11
        openbox-session &
        lxqt-session
        EOF

        # Force LXQt to use Openbox (avoid pop-up)
        mkdir -p ~/.config/lxqt
        cat > ~/.config/lxqt/session.conf << 'EOF'
        [General]
        window_manager=openbox
        EOF
        
        # Configure xrdp.ini for performance
        sudo sed -i 's/max_bpp=32/max_bpp=16/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/#tcp_nodelay=1/tcp_nodelay=1/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/#tcp_keepalive=1/tcp_keepalive=1/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/crypt_level=high/crypt_level=low/' /etc/xrdp/xrdp.ini
        
        # Add xrdp user to ssl-cert group
        sudo adduser xrdp ssl-cert
        
        # Start xrdp
        sudo systemctl start xrdp
        sudo systemctl status xrdp --no-pager

    - name: Set User Password
      run: |
        echo 'runner:p@ssw0rd!' | sudo chpasswd
        sudo usermod -aG sudo runner

    - name: Extra Performance Optimizations
      run: |
        # Disable heavy services
        sudo systemctl disable snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl stop snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl disable unattended-upgrades || true
        sudo systemctl stop unattended-upgrades || true
        sudo systemctl disable ModemManager || true
        sudo systemctl stop ModemManager || true

        # Kill pulseaudio (no sound = faster)
        systemctl --user stop pulseaudio.socket || true
        systemctl --user stop pulseaudio.service || true

        # CPU governor performance
        echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true

        # Network tweaks
        echo 'net.ipv4.tcp_window_scaling = 1' | sudo tee -a /etc/sysctl.conf
        echo 'net.ipv4.tcp_timestamps = 1' | sudo tee -a /etc/sysctl.conf
        echo 'vm.swappiness = 10' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p || true

        # Open firewall for RDP
        sudo ufw allow 3389/tcp || true

    - name: Start Playit Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        playit --secret $PLAYIT_AUTH_KEY &
        sleep 10
        
        echo "======================================"
        echo "âœ… RDP is ready!"
        echo "Server: via Playit tunnel"
        echo "Port: 3389"
        echo "Username: runner"
        echo "Password: p@ssw0rd!"
        echo "Desktop: LXQt + Openbox (lightweight)"
        echo "Optimizations: 16-bit color, no compositor, no audio"
        echo "======================================"

    - name: Keep Runner Alive
      run: |
        sleep 21600  # 6 hours
