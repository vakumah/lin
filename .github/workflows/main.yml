name: RDP LXDE Potato (Super Ringan)

on:
  workflow_dispatch:

jobs:
  rdp-rescue:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2

    - name: üöÄ Install Bore
      run: |
        wget -q https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-unknown-linux-musl.tar.gz
        tar -xf bore-v0.5.0-x86_64-unknown-linux-musl.tar.gz
        sudo mv bore /usr/local/bin/
        rm bore-v0.5.0-x86_64-unknown-linux-musl.tar.gz

    - name: üßπ Hapus Bloatware
      run: |
        sudo apt-get remove -y azure-cli google-cloud-cli dotnet-sdk-* llvm-* mono-* temurin-* mysql* php* firefox || true
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo systemctl disable snapd.service || true
        sudo systemctl stop snapd.service || true

    - name: üì¶ Install LXDE Core
      run: |
        sudo apt update
        # Install LXDE Core (Tanpa aplikasi sampah) + Browser
        sudo DEBIAN_FRONTEND=noninteractive apt install -y lxde-core lxde-common lxde-icon-theme xorg dbus-x11 x11-xserver-utils xfonts-base xfonts-100dpi xfonts-75dpi chromium-browser --no-install-recommends

    - name: ‚ö° Tuning Network
      run: |
        sudo sysctl -w net.ipv4.tcp_window_scaling=1
        sudo sysctl -w net.core.rmem_max=8388608
        sudo sysctl -w net.core.wmem_max=8388608

    - name: üîß Config VNC & LXDE
      run: |
        mkdir -p ~/.vnc
        touch ~/.Xauthority
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        # Startup script LXDE
        cat > ~/.vnc/xstartup << 'EOF'
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        
        # Load fonts
        xset +fp /usr/share/fonts/X11/misc/
        xset fp rehash
        
        # Start LXDE
        exec startlxde
        EOF
        chmod +x ~/.vnc/xstartup

    - name: üåê Fix Browser Shortcut
      run: |
        mkdir -p ~/Desktop
        # HAPUS flag --disable-software-rasterizer biar gambar muncul!
        cat > ~/Desktop/Chromium.desktop << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=Chromium Web
        Exec=chromium-browser --no-sandbox --disable-gpu --disable-dev-shm-usage --start-maximized
        Icon=chromium-browser
        Terminal=false
        EOF
        chmod +x ~/Desktop/Chromium.desktop

    # --- STEP 1: START VNC (Hanya Info) ---
    - name: üî• Start VNC & Get Link
      run: |
        # Start VNC (16-bit biar warna browser normal, tapi tetap ringan)
        vncserver :1 -geometry 1280x720 -depth 16 -pixelformat rgb565
        
        # Start Bore
        nohup bore local 5901 --to bore.pub > bore.log 2>&1 &
        sleep 5
        
        echo "========================================================"
        echo "‚úÖ LXDE DESKTOP READY!"
        echo "üîë Password: 123456"
        echo "üëá COPY ALAMAT INI:"
        echo ""
        grep -o "bore.pub:[0-9]*" bore.log || cat bore.log
        echo ""
        echo "========================================================"

    # --- STEP 2: KEEP ALIVE (Looping 6 Jam) ---
    - name: ‚è≥ Keep Alive (6 Jam)
      run: |
        echo "Server LXDE sedang berjalan..."
        end=$((SECONDS+21600))
        while [ $SECONDS -lt $end ]; do
            echo "RDP Alive - Sisa waktu: $(( (end - SECONDS) / 60 )) menit"
            sleep 60
        done
