name: Playit VNC Tunnel Linux Optimized

on:
  workflow_dispatch:

jobs:
  setup-vnc-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Download and Install Playit
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
        chmod +x playit-linux-amd64
        sudo mv playit-linux-amd64 /usr/local/bin/playit
        sleep 5

    - name: Install TightVNC and LXDE
      run: |
        sudo apt update
        # Install TightVNC, LXDE, and minimal dependencies
        sudo DEBIAN_FRONTEND=noninteractive apt install -y tightvncserver lxde lxde-common lxterminal openbox x11-xserver-utils
        
        # Setup VNC password
        mkdir -p ~/.vnc
        echo "p@ssw0rd!" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # Start VNC server on display :1 (port 5901)
        vncserver :1 -geometry 1024x768 -depth 16 -alwaysshared
        
        # Set LXDE session
        echo "startlxde" > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        
        # Configure LXDE for minimal resources
        mkdir -p ~/.config/pcmanfm/LXDE
        cat > ~/.config/pcmanfm/LXDE/desktop-items-0.conf << 'EOF'
        [*]
        desktop_bg=#000000
        desktop_fg=#ffffff
        desktop_shadow=#000000
        show_thumbnails=false
        show_hidden=false
        desktop_font=Sans 10
        EOF
        
        mkdir -p ~/.config/openbox
        cat > ~/.config/openbox/lxde-rc.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <openbox_config xmlns="http://openbox.org/3.4/rc">
          <resistance><strength>10</strength><screen_edge_strength>20</screen_edge_strength></resistance>
          <focus><focusNew>yes</focusNew><followMouse>no</followMouse><focusLast>yes</focusLast><underMouse>no</underMouse><focusDelay>200</focusDelay><raiseOnFocus>no</raiseOnFocus></focus>
          <placement><policy>Smart</policy><center>yes</center><monitor>Primary</monitor></placement>
          <theme><name>Clearlooks</name><titleLayout>NLIMC</titleLayout><keepBorder>yes</keepBorder><animateIconify>no</animateIconify><font place="ActiveWindow"><name>Sans</name><size>10</size><weight>Normal</weight><slant>Normal</slant></font></theme>
          <desktops><number>1</number><firstdesk>1</firstdesk><names><name>Desktop</name></names><popupTime>0</popupTime></desktops>
          <resize><drawContents>yes</drawContents><popupShow>Nonpixel</popupShow><popupPosition>Center</popupPosition></resize>
          <applications /><keyboard><chainQuitKey>C-g</chainQuitKey></keyboard>
          <menu><file>menu.xml</file><hideDelay>200</hideDelay><middle>no</middle><submenuShowDelay>100</submenuShowDelay><applicationMenu>yes</applicationMenu><showIcons>yes</showIcons></menu>
        </openbox_config>
        EOF
        
        # Firewall
        sudo ufw allow 5901/tcp || true

    - name: Set User Password
      run: |
        echo 'runner:p@ssw0rd!' | sudo chpasswd
        sudo usermod -aG sudo runner

    - name: Advanced Performance Optimization
      run: |
        # Disable heavy services
        sudo systemctl disable snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl stop snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl disable unattended-upgrades || true
        sudo systemctl stop unattended-upgrades || true
        sudo systemctl disable ModemManager || true
        sudo systemctl stop ModemManager || true
        
        # CPU to performance
        echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true
        
        # Network tweaks for animations
        echo 'net.ipv4.tcp_window_scaling = 1' | sudo tee -a /etc/sysctl.conf
        echo 'net.ipv4.tcp_timestamps = 1' | sudo tee -a /etc/sysctl.conf
        echo 'vm.swappiness = 10' | sudo tee -a /etc/sysctl.conf
        echo 'net.core.rmem_max=33554432' | sudo tee -a /etc/sysctl.conf
        echo 'net.core.wmem_max=33554432' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p || true

    - name: Start Playit and Set Up VNC Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        playit --secret $PLAYIT_AUTH_KEY --port 5901 &
        sleep 10
        
        echo "VNC ready on port 5901"
        echo "Username: runner | Password: p@ssw0rd!"
        echo "DE: LXDE (Ultra Lightweight, Optimized for Animations)"
        echo "Tips: Use 1024x768, 16-bit color, VNC client (TightVNC/Remmina), install browser manually if needed"

    - name: Keep Alive
      run: |
        sleep 21600  # 6 hours
