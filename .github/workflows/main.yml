name: Playit RDP Tunnel Linux

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Download and Install Playit
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit-linux-amd64
        sudo mv playit-linux-amd64 /usr/local/bin/playit
        sleep 5

    - name: Install and Configure xRDP with Performance Optimizations
      run: |
        sudo apt update
        # Install minimal desktop with proper window manager
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xrdp lxde-core lxde-common lxterminal pcmanfm openbox obconf lxappearance
        
        # Configure xrdp for maximum performance
        sudo systemctl enable xrdp
        
        # Set LXDE with Openbox window manager
        echo "exec startlxde" > ~/.xsession
        
        # Configure Openbox for proper window controls
        mkdir -p ~/.config/openbox
        cp /etc/xdg/openbox/rc.xml ~/.config/openbox/ || true
        cp /etc/xdg/openbox/menu.xml ~/.config/openbox/ || true
        cp /etc/xdg/openbox/autostart ~/.config/openbox/ || true
        
        # Configure xrdp.ini for performance - use simple sed approach
        sudo sed -i 's/max_bpp=32/max_bpp=16/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/#tcp_nodelay=1/tcp_nodelay=1/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/#tcp_keepalive=1/tcp_keepalive=1/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/crypt_level=high/crypt_level=low/' /etc/xrdp/xrdp.ini
        
        # Add xrdp user to ssl-cert group
        sudo adduser xrdp ssl-cert
        
        # Start xrdp service
        sudo systemctl start xrdp
        
        # Check if service is running
        sudo systemctl status xrdp --no-pager
        
    - name: Set User Password
      run: |
        echo 'runner:p@ssw0rd!' | sudo chpasswd
        sudo usermod -aG sudo runner

    - name: Advanced Performance Optimization
      run: |
        # Disable heavy services and background processes
        sudo systemctl disable snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl stop snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl disable unattended-upgrades || true
        sudo systemctl stop unattended-upgrades || true
        sudo systemctl disable ModemManager || true
        sudo systemctl stop ModemManager || true
        
        # Set CPU governor to performance mode
        echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true
        
        # Basic network optimizations
        echo 'net.ipv4.tcp_window_scaling = 1' | sudo tee -a /etc/sysctl.conf
        echo 'net.ipv4.tcp_timestamps = 1' | sudo tee -a /etc/sysctl.conf
        echo 'vm.swappiness = 10' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p || true
        
        # Configure Openbox for better window management
        mkdir -p ~/.config/openbox
        
        # Create Openbox config with proper window controls
        cat > ~/.config/openbox/rc.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <openbox_config xmlns="http://openbox.org/3.4/rc">
          <resistance>
            <strength>10</strength>
            <screen_edge_strength>20</screen_edge_strength>
          </resistance>
          <focus>
            <focusNew>yes</focusNew>
            <followMouse>no</followMouse>
            <focusLast>yes</focusLast>
            <underMouse>no</underMouse>
            <focusDelay>200</focusDelay>
            <raiseOnFocus>no</raiseOnFocus>
          </focus>
          <placement>
            <policy>Smart</policy>
            <center>yes</center>
            <monitor>Primary</monitor>
            <primaryMonitor>1</primaryMonitor>
          </placement>
          <theme>
            <name>Clearlooks</name>
            <titleLayout>NLIMC</titleLayout>
            <keepBorder>yes</keepBorder>
            <animateIconify>no</animateIconify>
            <font place="ActiveWindow">
              <name>sans</name>
              <size>8</size>
              <weight>bold</weight>
              <slant>normal</slant>
            </font>
            <font place="InactiveWindow">
              <name>sans</name>
              <size>8</size>
              <weight>bold</weight>
              <slant>normal</slant>
            </font>
          </theme>
          <desktops>
            <number>1</number>
            <firstdesk>1</firstdesk>
            <names>
              <name>Desktop</name>
            </names>
            <popupTime>875</popupTime>
          </desktops>
          <resize>
            <drawContents>yes</drawContents>
            <popupShow>Nonpixel</popupShow>
            <popupPosition>Center</popupPosition>
            <popupFixedPosition>
              <x>10</x>
              <y>10</y>
            </popupFixedPosition>
          </resize>
          <mouse>
            <dragThreshold>1</dragThreshold>
            <doubleClickTime>500</doubleClickTime>
            <screenEdgeWarpTime>0</screenEdgeWarpTime>
            <screenEdgeWarpMouse>false</screenEdgeWarpMouse>
            <context name="Frame">
              <mousebind button="A-Left" action="Press">
                <action name="Focus"/>
                <action name="Raise"/>
              </mousebind>
              <mousebind button="A-Left" action="Click">
                <action name="Unshade"/>
              </mousebind>
              <mousebind button="A-Left" action="Drag">
                <action name="Move"/>
              </mousebind>
              <mousebind button="A-Right" action="Press">
                <action name="Focus"/>
                <action name="Raise"/>
                <action name="Unshade"/>
              </mousebind>
              <mousebind button="A-Right" action="Drag">
                <action name="Resize"/>
              </mousebind>
              <mousebind button="A-Middle" action="Press">
                <action name="Lower"/>
                <action name="FocusToBottom"/>
                <action name="Unfocus"/>
              </mousebind>
              <mousebind button="A-Up" action="Click">
                <action name="GoToDesktop"><to>previous</to></action>
              </mousebind>
              <mousebind button="A-Down" action="Click">
                <action name="GoToDesktop"><to>next</to></action>
              </mousebind>
              <mousebind button="C-A-Up" action="Click">
                <action name="GoToDesktop"><to>previous</to></action>
              </mousebind>
              <mousebind button="C-A-Down" action="Click">
                <action name="GoToDesktop"><to>next</to></action>
              </mousebind>
              <mousebind button="A-S-Up" action="Click">
                <action name="SendToDesktop"><to>previous</to></action>
              </mousebind>
              <mousebind button="A-S-Down" action="Click">
                <action name="SendToDesktop"><to>next</to></action>
              </mousebind>
            </context>
            <context name="Titlebar">
              <mousebind button="Left" action="Drag">
                <action name="Move"/>
              </mousebind>
              <mousebind button="Left" action="DoubleClick">
                <action name="ToggleMaximize"/>
              </mousebind>
              <mousebind button="Up" action="Click">
                <action name="if">
                  <shaded>no</shaded>
                  <then>
                    <action name="Shade"/>
                    <action name="FocusToBottom"/>
                    <action name="Unfocus"/>
                  </then>
                </action>
              </mousebind>
              <mousebind button="Down" action="Click">
                <action name="if">
                  <shaded>yes</shaded>
                  <then>
                    <action name="Unshade"/>
                    <action name="Raise"/>
                  </then>
                </action>
              </mousebind>
            </context>
          </mouse>
        </openbox_config>
        EOF
        
        # Create simple LXDE config for better performance
        mkdir -p ~/.config/lxsession/LXDE
        echo '[GTK]' > ~/.config/lxsession/LXDE/desktop.conf
        echo 'sNet/ThemeName=Adwaita' >> ~/.config/lxsession/LXDE/desktop.conf
        echo 'iGtk/ButtonImages=0' >> ~/.config/lxsession/LXDE/desktop.conf
        echo 'iGtk/MenuImages=0' >> ~/.config/lxsession/LXDE/desktop.conf
        
        # Configure firewall
        sudo ufw allow 3389/tcp || true

    - name: Start Playit and Set Up RDP Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }} 
      run: |
        playit --secret $PLAYIT_AUTH_KEY &
        sleep 10
        
        # Show connection info
        echo "RDP is ready on port 3389"
        echo "Username: runner"
        echo "Password: p@ssw0rd!"
        echo "Desktop Environment: LXDE with Openbox (Full Window Controls)"
        echo "Optimizations: Low color depth, fast compression, minimal UI"
        
    # Prevent workflow to stop
    - name: Keep the GitHub Action Runner Alive
      run: |
        sleep 21600  # Increased to 6 hours for public repo with no minute limit
