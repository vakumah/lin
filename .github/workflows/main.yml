name: Playit RDP Tunnel Linux Optimized

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Download and Install Playit
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
        chmod +x playit-linux-amd64
        sudo mv playit-linux-amd64 /usr/local/bin/playit
        sleep 5

    - name: Install xRDP with H.264 and Performance Script
      run: |
        sudo apt update
        # Download and run xRDP installer script v1.5.4 with H.264 for better animation/video
        cd /tmp
        wget https://www.c-nergy.be/downloads/xRDP/xrdp-installer-1.5.4.zip
        unzip xrdp-installer-1.5.4.zip
        chmod +x xrdp-installer-1.5.4.sh
        sudo ./xrdp-installer-1.5.4.sh -e  # -e for H.264 encoding
        
        # Install lightweight DE: XFCE (better than GNOME for xRDP)
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-terminal thunar
        
        # Set XFCE session
        echo "xfce4-session" > ~/.xsession
        
        # Additional tweaks post-installer (for max perf)
        sudo sed -i 's/crypt_level=low/crypt_level=None/' /etc/xrdp/xrdp.ini  # No encryption for speed
        sudo sed -i 's/max_bpp=16/max_bpp=15/' /etc/xrdp/xrdp.ini
        sudo sed -i 's/XServerbpp=16/XServerbpp=15/' /etc/xrdp/sesman.ini
        
        # Restart services
        sudo systemctl restart xrdp xrdp-sesman
        
        # Check status
        sudo systemctl status xrdp --no-pager
        
    - name: Set User Password
      run: |
        echo 'runner:p@ssw0rd!' | sudo chpasswd
        sudo usermod -aG sudo runner

    - name: Advanced Performance Optimization
      run: |
        # Disable heavy services
        sudo systemctl disable snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl stop snapd.service snapd.socket snapd.seeded.service || true
        sudo systemctl disable unattended-upgrades || true
        sudo systemctl stop unattended-upgrades || true
        sudo systemctl disable ModemManager || true
        sudo systemctl stop ModemManager || true
        
        # CPU to performance
        echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true
        
        # Network tweaks (bigger buffers for animation data)
        echo 'net.ipv4.tcp_window_scaling = 1' | sudo tee -a /etc/sysctl.conf
        echo 'net.ipv4.tcp_timestamps = 1' | sudo tee -a /etc/sysctl.conf
        echo 'vm.swappiness = 10' | sudo tee -a /etc/sysctl.conf
        echo 'net.core.rmem_max=33554432' | sudo tee -a /etc/sysctl.conf  # 32MB for smoother streaming
        echo 'net.core.wmem_max=33554432' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p || true
        
        # XFCE config (disable all visual effects)
        mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml
        
        cat > ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <channel name="xfwm4" version="1.0">
          <property name="general" type="empty">
            <property name="use_compositing" type="bool" value="false"/>
            <property name="show_frame_shadow" type="bool" value="false"/>
            <property name="show_popup_shadow" type="bool" value="false"/>
            <property name="snap_to_border" type="bool" value="true"/>
            <property name="snap_to_windows" type="bool" value="true"/>
            <property name="snap_width" type="int" value="10"/>
            <property name="theme" type="string" value="Default"/>
            <property name="title_font" type="string" value="Sans Bold 9"/>
            <property name="double_click_action" type="string" value="maximize"/>
            <property name="easy_click" type="string" value="Alt"/>
            <property name="focus_mode" type="string" value="click"/>
            <property name="placement_mode" type="string" value="center"/>
            <property name="raise_delay" type="int" value="250"/>
            <property name="resize_opacity" type="int" value="100"/>
            <property name="move_opacity" type="int" value="100"/>
            <property name="show_dock_shadow" type="bool" value="false"/>
            <property name="workspace_count" type="int" value="1"/>
          </property>
        </channel>
        EOF
        
        cat > ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <channel name="xfce4-desktop" version="1.0">
          <property name="desktop-icons" type="empty">
            <property name="style" type="int" value="0"/>
            <property name="file-icons" type="empty">
              <property name="show-thumbnails" type="bool" value="false"/>
            </property>
          </property>
          <property name="backdrop" type="empty">
            <property name="screen0" type="empty">
              <property name="monitor0" type="empty">
                <property name="color-style" type="int" value="0"/>
                <property name="image-style" type="int" value="0"/>
              </property>
            </property>
          </property>
        </channel>
        EOF
        
        # Firewall
        sudo ufw allow 3389/tcp || true

    - name: Start Playit and Set Up RDP Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }} 
      run: |
        playit --secret $PLAYIT_AUTH_KEY &
        sleep 10
        
        echo "RDP ready on port 3389"
        echo "Username: runner | Password: p@ssw0rd!"
        echo "DE: XFCE4 Optimized + H.264 for animations"
        echo "Tips: Use low res (1024x768), disable browser HW accel"
        
    - name: Keep Alive
      run: |
        sleep 21600  # 6 hours
